<!DOCTYPE html>
<html lang="en" data-teaching-language="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NativeSpark AI - Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/home.css">
    
    <link rel="stylesheet" href="../css/zeno.css">
    <!-- In home-ai.html, add this script tag -->
    
  <!-- Favicon links for all sizes -->
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
    <link rel="icon" href="../assets/favicon.ico">
    <link rel="manifest" href="../site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
   
</head>
<body>
    
 <div class="head" style="display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; background-color: black; padding: 10px 0;
    border-bottom: 1px solid rgba(46, 204, 113, 0.3);">
    <!-- Text Block -->
      <div>
        <img src="../assets/srm.jpg" alt="SRM Logo" style="height: 80px; width: auto; border-radius: 5px;">
    </div>
    <div style="display: flex; flex-direction: column; text-align: center; line-height: 1.2;">
        <h2 style="margin: 0; font-size: 1.6rem; font-weight: bold;">  SRM VALLIAMMAI ENGINEERING COLLEGE (An Autonomous Institution)</h2>
        <p style="margin: 2px 0; font-style: italic; font-size: 1rem;"></p>
        <h3 style="margin: 2px 0; font-size: 1.2rem; font-weight: 500;">DEPARTMENT OF ARTIFICIAL INTELLIGENCE AND DATA SCIENCE</h3>
        <h4 style="margin: 2px 0; font-size: 1.1rem; color: #00b0e6ea; font-weight: 800;">AI-BASED LANGUAGE LEARNING PLATFORM</h4>
    </div>
    <!-- Logo -->
    <div>
        <img src="../assets/srm logo.jpg" alt="SRM Logo" style="height: 80px; width: auto;border-radius: 5px;">
    </div>
    
</div>

    <!-- Header -->
    <header class="header">
        
        <div class="logo"> <img src="../assets/favicon-32x32.png" alt="NativeSpark Logo" class="logo-icon"> NativeSpark AI</div>
        <div class="header-actions">
            <button class="dictionary-btn" onclick="openDictionary()">
    üìñ Dictionary
</button>

            <button class="continue-btn" onclick="continueLearning()">
                üìö Continue Learning
            </button>
        </div>
        <div class="user-header">
            <div class="user-profile">
               <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                <span id="userName">Language Learner</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Zeno Assistant -->
  <div id="zeno-assistant" class="zeno-assistant">
    <div class="assistant-toggle" id="assistant-toggle">
        <img src="../assets/astronaut-WTFWARES copy.png" alt="Zeno" class="assistant-avatar">
        <span class="assistant-status"></span>
    </div>

      <div class="assistant-chat" id="assistant-chat">
        <div class="chat-header">
            <h4>Zeno - Your AI Guide</h4>
          
            <button class="close-chat">&times;</button>
        </div>
         
<div class="language-selector">
            <label for="language-select">üåê Response Language:</label>
            <select id="language-select">
                <option value="auto">Auto (User's language)</option>
                <option value="english">English</option>
                <option value="tamil">Tamil - ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="spanish">Espa√±ol (Spanish)</option>
                <option value="french">Fran√ßais (French)</option>
                <option value="german">Deutsch (German)</option>
                <option value="japanese">Êó•Êú¨Ë™û (Japanese)</option>
                <option value="hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
            </select>
            <div class="language-info" id="language-info">Language: Auto-detect</div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-container">
            <div class="input-group">
                <input type="text" id="chat-input" placeholder="Ask Zeno anything..." maxlength="500">
                <button id="send-message" class="send-btn">‚û§</button>
                <button id="voice-toggle" class="voice-btn">üé§</button>
            </div>
            <div class="chat-controls">
                <button id="clear-chat" class="clear-btn">Clear Chat</button>
                
                <span class="typing-indicator" id="typing-indicator">Zeno is typing...</span>
            </div>
        </div>
    </div>
</div>
    <!-- Game Popup -->
    <div id="gamePopup" class="game-popup-overlay hidden">
        <div class="popup-backdrop"></div>
        <div class="popup-character-modal">
            <div class="popup-astronaut-character">
                <img class="popup-astronaut-image" src="../assets/astronaut-WTFWARES copy.png" alt="Astronaut Character">
            </div>
            <div class="popup-speech-bubble">
                <div class="popup-message-text" id="popupMessage">
                    Welcome back, Space Explorer! Ready to continue your language learning adventure?
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome Section -->
        <section class="welcome-section">
            <h1 class="welcome-title">Welcome back, <span id="welcomeName">Friend</span>!</h1>
            <p class="welcome-subtitle" id="welcomeSubtitle">
                Continue your exciting language learning journey with Zeno
            </p>
            
            <div class="learning-info">
                <div class="info-item">
                    <div class="info-label">Learning</div>
                    <div class="info-value" id="targetLang">Spanish</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Teaching Language</div>
                    <div class="info-value" id="teachingLang">English</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Current Level</div>
                    <div class="info-value" id="userLevel">Beginner</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Days Learning</div>
                    <div class="info-value" id="daysLearning">7</div>
                </div>
            </div>
        </section>

      <section class="progress-section">
    <h2 class="section-title">
  <span style="
    all: initial;
    display: inline-block;
    font-size: 2rem;
    line-height: normal;
    color: black;
  ">üìä</span>
  Your Learning Journey
</h2>


    
    <div class="progress-bar-container">
        <div class="progress-label">
    <span>Overall Progress</span>
    <span id="overallProgress" style="margin-right: 110px;">0%</span>

</div>
<div class="progress-bar" style="width: 90%; text-align: left;">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
</div>

        <!-- Menu button will be added here by JavaScript -->
    </div>
</section>

<script src="../js/progress-tracker.js" defer></script>

<!-- Initialize Progress Tracker after Firebase loads -->
<script type="module">
// Wait for both Firebase and tracker to load
window.addEventListener('load', async () => {
    console.log('üîÑ Initializing progress tracker...');
    
    // Wait for Firebase to be available
    let attempts = 0;
    const maxAttempts = 50; // 5 seconds max
    
    const waitForFirebase = setInterval(() => {
        attempts++;
        
        if (window.auth && window.db && window.tracker) {
            clearInterval(waitForFirebase);
            console.log('‚úÖ Firebase and tracker loaded, initializing...');
            
            // Give it a moment to fully initialize
            setTimeout(() => {
                window.tracker.updateProgressBar();
                console.log('‚úÖ Progress tracker ready!');
            }, 500);
            
        } else if (attempts >= maxAttempts) {
            clearInterval(waitForFirebase);
            console.warn('‚ö†Ô∏è Timeout waiting for Firebase/tracker');
            
            // Initialize with local storage fallback
            if (window.tracker) {
                window.tracker.loadLocalProgress();
            }
        }
    }, 100);
});
</script>

        <!-- Learning Modules -->
        <section class="modules-section">
            <h2 class="section-title">
  <span style="
    all: initial;
    display: inline-block;
    font-size: 2rem;
    line-height: normal;
    color: black;
  ">üéØ</span>
  Learning Modules
</h2>
            
            <div class="modules-grid">
                <div class="module-card current" onclick="openModule('alphabets')">
                    <div class="module-icon">üî§</div>
                    <div class="module-title">AI Alphabets</div>
                    <div class="module-desc">Master the building blocks with interactive AI-powered alphabet learning</div>
                    <div class="module-status status-current">üìç Current</div>
                </div>
                
                <div class="module-card current" onclick="openModule('vocabulary')">
                    <div class="module-icon">üìñ</div>
                    <div class="module-title">Smart Vocabulary</div>
                    <div class="module-desc">Build your word power with AI-personalized vocabulary training</div>
                    <div class="module-status status-current">üìç Current</div>
                </div>
                
               <!-- Remove the 'locked' class from grammar and assessment cards -->

<div class="module-card current" onclick="openModule('grammar')">
    <div class="module-icon">üìù</div>
    <div class="module-title">Intelligent Grammar</div>
    <div class="module-desc">Learn grammar rules with AI-generated exercises and feedback</div>
    <div class="module-status status-current">üìç Available</div>
</div>

<div class="module-card current" onclick="openModule('assessment')">
    <div class="module-icon">üéì</div>
    <div class="module-title">Adaptive Assessment</div>
    <div class="module-desc">Test your knowledge with AI-powered adaptive exams</div>
    <div class="module-status status-current">üìç Available</div>
</div>
            </div>
        </section>

        

        <!-- Quick Actions -->
        <section class="quick-actions">
            <h2 class="section-title">  <span style="
    all: initial;
    display: inline-block;
    font-size: 2rem;
    line-height: normal;
    color: black;
  ">‚ö°</span> Quick Actions</h2>
            
            <div class="actions-grid">
                <button class="action-btn" onclick="openPractice()">
                    <span class="action-icon">üéØ</span>
                    <span class="action-text">Practice Mode</span>
                </button>
                <button class="action-btn secondary" onclick="openSettings()">
                    <span class="action-icon">‚öôÔ∏è</span>
                    <span class="action-text">Change Languages</span>
                </button>
               
               
      
        <button class="action-btn" onclick="resetJourney()" style="background: #f44336;">
            <span class="action-icon">üîÑ</span>
            <span class="action-text">Reset Journey</span>
        </button>
      <button class="action-btn info" onclick="openProjectInfo()" style="background: #2196f3;">
    <span class="action-icon">‚ÑπÔ∏è</span>
    <span class="action-text">About Project</span>
</button>
      
    </div>
</section>

</div>

<div id="projectInfoModalOverlay" style="z-index: 9999; display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
    <div class="project-info-modal-box" style="position: relative; z-index: 10000; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); padding: 40px; border-radius: 15px; max-width: 800px; width: 90%; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3); max-height: 90vh; overflow-y: auto;">
        <span onclick="closeProjectInfo()" style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 32px; color: #666; line-height: 1; transition: color 0.3s;">&times;</span>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="margin: 0; color: #2196f3; font-size: 28px; font-weight: bold;">üìù AI-Based Language Learning Platform</h2>
            <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">NativeSpark - Learn Languages Through Your Mother Tongue</p>
        </div>
        
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #2196f3;">
            <h3 style="margin: 0 0 10px 0; color: #1976d2; font-size: 18px;">üéì Project Overview</h3>
            <p style="color: #555; line-height: 1.7; margin: 0;">This innovative platform revolutionizes language learning by leveraging advanced AI technologies, real-time speech processing, and adaptive learning methods. It teaches new languages using the learner's mother tongue, offering a natural, intuitive, and engaging experience for learners of all proficiency levels.</p>
        </div>

        <div style="margin-bottom: 25px;">
            <h3 style="margin: 0 0 15px 0; color: #2196f3; font-size: 20px; border-bottom: 2px solid #2196f3; padding-bottom: 8px;">üöÄ Core Features</h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">Multilingual Support:</strong> Learn from 5+ languages including English, Tamil, Hindi, French, and German with audio integration
                </li>
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">Adaptive AI Practice Mode:</strong> Dynamic exercises with real-time feedback powered by Groq LLaMA 3.1 & 3.3, HuggingFace Zephyr
                </li>
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">AI Chatbot:</strong> Interactive conversational practice with multi-turn dialogue and context awareness
                </li>
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">Comprehensive Modules:</strong> Vocabulary building, grammar lessons, sentence formation, and pronunciation guidance
                </li>
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">Speech Recognition:</strong> Real-time pronunciation feedback using Web Speech API and TTS technology
                </li>
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">Isolated AI Dictionary:</strong> Context-aware translations with usage examples and grammar tips
                </li>
                <li style="padding: 12px 0; padding-left: 35px; position: relative; color: #444; line-height: 1.6; border-bottom: 1px solid #eee;">
                    <span style="position: absolute; left: 0; color: #4caf50; font-weight: bold; font-size: 18px;">‚úì</span>
                    <strong style="color: #333;">Progress Tracking:</strong> Detailed analytics with Firebase integration and weighted completion metrics
                </li>
               
            </ul>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border: 2px solid #ff9800;">
                <h4 style="margin: 0 0 8px 0; color: #f57c00; font-size: 16px;">ü§ñ AI Technologies</h4>
                <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.5;">Groq LLaMA 3.1 & 3.3<br>HuggingFace Zephyr 7B<br>Ollama Local Models<br>NLP & Speech APIs</p>
            </div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border: 2px solid #4caf50;">
                <h4 style="margin: 0 0 8px 0; color: #388e3c; font-size: 16px;">üíæ Tech Stack</h4>
                <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.5;">HTML, CSS, JavaScript<br>Firebase & Firestore<br>Web Speech API<br>JSON Curriculum</p>
            </div>
        </div>

        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 12px 0; color: #7b1fa2; font-size: 18px;">üë• Development Team</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #555; font-size: 14px;">
                <div><strong>Rajesh P</strong> - 142222243037</div>
                <div><strong>Santhosh M</strong> - 142222243040</div>
                <div><strong>Sudharsan G</strong> - 142222243047</div>
                <div><strong>Suman T</strong> - 142222243048</div>
            </div>
            <p style="margin: 15px 0 0 0; font-size: 13px; color: #666;"><strong>Institution:</strong> SRM Valliammai Engineering College, Department of AI & Data Science</p>
            <p style="margin: 5px 0 0 0; font-size: 13px; color: #666;"><strong>Supervisor:</strong> Mr. S. Srinivasan, M.E. | <strong>HOD:</strong> Dr. B. Muthusenthil, M.E., Ph.D.</p>
        </div>

        <div style="text-align: center; padding-top: 15px; border-top: 2px solid #e0e0e0;">
            <p style="margin: 0; color: #888; font-size: 13px;">üìÖ Project Completion: October 2025 | Anna University, Chennai</p>
        </div>
    </div>
</div>

<script>
function openProjectInfo() {
    document.getElementById('projectInfoModalOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeProjectInfo() {
    document.getElementById('projectInfoModalOverlay').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
}

// Close modal when clicking outside
document.getElementById('projectInfoModalOverlay')?.addEventListener('click', function(e) {
    if (e.target.id === 'projectInfoModalOverlay') {
        closeProjectInfo();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeProjectInfo();
    }
});
</script>
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">‚öôÔ∏è Settings</h3>
            <button class="close-btn" onclick="closeSettings()">√ó</button>
        </div>
        
        <div class="modal-body">
            <!-- Language Settings Section -->
            <div class="settings-section">
                <h4 class="section-heading">üåê Language Settings</h4>
                <p class="section-description">Change your native and learning languages</p>
                
                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">üè†</span>
                        Teaching Language (Your Native Language)
                    </label>
                    <select class="form-select" id="teachingLanguageSelect">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="ta">üáÆüá≥ Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                        <option value="hi">üáÆüá≥ Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                        <option value="fr">üá´üá∑ French (Fran√ßais)</option>
                        <option value="de">üá©üá™ German (Deutsch)</option>
                    </select>
                    <small class="form-hint">This is the language used to teach you</small>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">üéØ</span>
                        Target Language (What You Want to Learn)
                    </label>
                    <select class="form-select" id="targetLanguageSelect">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="ta">üáÆüá≥ Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                        <option value="hi">üáÆüá≥ Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                        <option value="fr">üá´üá∑ French (Fran√ßais)</option>
                        <option value="de">üá©üá™ German (Deutsch)</option>
                    </select>
                    <small class="form-hint">This is the language you're learning</small>
                </div>

                <div class="warning-box">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <div class="warning-content">
                        <strong>Important:</strong> Changing languages will update your entire learning experience. 
                        Your progress in the current language will be preserved.
                    </div>
                </div>
            </div>

            <!-- Danger Zone Section -->
           
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeSettings()">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="saveSettings()">
                üíæ Save Changes
            </button>
        </div>
    </div>
</div>
</br></br>
   <footer style="text-align: center; padding: 15px; background-color: rgba(245, 245, 245, 0); border-top: 1px solid rgba(46, 204, 113, 0.3); font-family: 'Segoe UI', Arial, sans-serif; color: #ffffff; font-size: 14px; line-height: 1.6; letter-spacing: 0.3px;">
    <p style="margin: 5px 0; font-weight: 500;">Copyright ¬© 2025 Department of Artificial Intelligence and Data Science, SRM Valliammai Engineering College</p>
    <p style="margin: 5px 0; color: #ffffff; font-weight: 500;">
        RAJESH P - 142222243037 | 
        SANTHOSH M - 142222243040 | 
        SUDHARSAN G - 142222243047 | 
        SUMAN T - 142222243048
    </p>
</footer>



 <script type="module" src="../js/ai-assistant.js"></script>
  <script>
    // COMPLETE CHAT UI WITH LANGUAGE SELECTION & VOICE INPUT
// Place this script in your HTML after the AI Assistant module import

function waitForAIAssistant(callback, timeout = 5000) {
    const startTime = Date.now();
    
    const checkInterval = setInterval(() => {
        if (window.aiAssistant && typeof window.aiAssistant.sendMessage === 'function') {
            clearInterval(checkInterval);
            console.log('‚úÖ AI Assistant is ready!');
            callback();
        } else if (Date.now() - startTime > timeout) {
            clearInterval(checkInterval);
            console.error('‚ùå AI Assistant failed to load in time');
            alert('AI Assistant failed to load. Please refresh the page.');
        }
    }, 100);
}

// Initialize chat UI with language selection and voice input
function initializeChatUI() {
    console.log('üé® Initializing enhanced chat UI...');
    
    // Get DOM elements
    const chatToggle = document.getElementById('assistant-toggle');
    const chatContainer = document.getElementById('assistant-chat');
    const closeButton = document.querySelector('.close-chat');
    const sendButton = document.getElementById('send-message');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const clearButton = document.getElementById('clear-chat');
    const voiceButton = document.getElementById('voice-toggle');
    const languageSelect = document.getElementById('language-select');
    const languageInfo = document.getElementById('language-info');
    const typingIndicator = document.getElementById('typing-indicator');

    // Verify essential elements
    if (!chatToggle || !chatContainer || !closeButton || !sendButton || !chatInput || !chatMessages) {
        console.error('‚ùå Missing essential chat UI elements');
        return;
    }

    console.log('‚úÖ All chat UI elements found');

    // =====================
    // LANGUAGE SELECTION
    // =====================
    
    // Set initial language from AI Assistant
    if (languageSelect && window.aiAssistant) {
        const currentLang = window.aiAssistant.getCurrentLanguage();
        languageSelect.value = currentLang.code;
        updateLanguageInfo(currentLang.code);
    }

    // Language selection change handler
    if (languageSelect) {
        languageSelect.addEventListener('change', function(e) {
            const selectedLanguage = e.target.value;
            
            if (window.aiAssistant) {
                const success = window.aiAssistant.setLanguage(selectedLanguage);
                
                if (success) {
                    updateLanguageInfo(selectedLanguage);
                    console.log('üåê Language changed to:', selectedLanguage);
                    
                    // Notify user
                    addMessageToChat('system', `üåê Language set to: ${getLanguageDisplayName(selectedLanguage)}`);
                    
                    // If speech recognition is available, update it
                    if (window.aiAssistant.isSpeechAvailable()) {
                        addMessageToChat('system', `üé§ Voice input language updated`);
                    }
                } else {
                    console.error('‚ùå Failed to change language');
                    addMessageToChat('system', '‚ö†Ô∏è Failed to change language. Please try again.');
                }
            }
        });
    }

    function updateLanguageInfo(langCode) {
        if (!languageInfo) return;
        
        const langName = getLanguageDisplayName(langCode);
        languageInfo.textContent = `Language: ${langName}`;
        languageInfo.style.color = langCode === 'auto' ? '#666' : '#4CAF50';
    }

    function getLanguageDisplayName(code) {
        const names = {
            'auto': 'Auto-detect',
            'english': 'English',
            'tamil': 'Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)',
            'spanish': 'Spanish (Espa√±ol)',
            'french': 'French (Fran√ßais)',
            'german': 'German (Deutsch)',
            'japanese': 'Japanese (Êó•Êú¨Ë™û)',
            'hindi': 'Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)'
        };
        return names[code] || code;
    }

    // =====================
    // VOICE INPUT (RECORDING)
    // =====================
    
    let isRecording = false;
    let voiceInputActive = false;

    // Setup voice input callbacks
    if (window.aiAssistant && window.aiAssistant.isSpeechAvailable()) {
        // On speech start
        window.aiAssistant.onSpeechStart = () => {
            isRecording = true;
            voiceInputActive = true;
            updateVoiceButtonState(true);
            addMessageToChat('system', 'üé§ Listening... Speak now');
        };

        // On speech end
        window.aiAssistant.onSpeechEnd = () => {
            isRecording = false;
            updateVoiceButtonState(false);
        };

        // On speech result
        window.aiAssistant.onSpeechResult = (transcript, confidence) => {
            voiceInputActive = false;
            console.log('üé§ Transcript received:', transcript);
            
            // Insert transcript into input
            chatInput.value = transcript;
            chatInput.focus();
            
            // Show confidence level
            const confidencePercent = Math.round(confidence * 100);
            addMessageToChat('system', `‚úÖ Recognized (${confidencePercent}% confidence): "${transcript}"`);
            
            // Optionally auto-send if confidence is high
            if (confidence > 0.8) {
                setTimeout(() => {
                    sendMessage();
                }, 500);
            }
        };

        // On speech error
        window.aiAssistant.onSpeechError = (error) => {
            voiceInputActive = false;
            isRecording = false;
            updateVoiceButtonState(false);
            
            console.error('üé§ Speech error:', error);
            
            const errorMessages = {
                'no-speech': 'No speech detected. Please try again.',
                'audio-capture': 'Microphone not accessible. Check permissions.',
                'not-allowed': 'Microphone permission denied.',
                'network': 'Network error. Check your connection.',
                'aborted': 'Recording stopped.',
                'default': 'Voice input error. Please try again.'
            };
            
            const message = errorMessages[error] || errorMessages['default'];
            addMessageToChat('system', `‚ö†Ô∏è ${message}`);
        };
    }

    // Voice button click handler
    if (voiceButton) {
        voiceButton.addEventListener('click', function() {
            if (!window.aiAssistant || !window.aiAssistant.isSpeechAvailable()) {
                addMessageToChat('system', '‚ö†Ô∏è Voice input not supported in this browser. Try Chrome or Edge.');
                return;
            }

            if (isRecording) {
                // Stop recording
                window.aiAssistant.stopListening();
                updateVoiceButtonState(false);
            } else {
                // Start recording
                const started = window.aiAssistant.startListening();
                if (!started) {
                    addMessageToChat('system', '‚ö†Ô∏è Could not start voice input. Please try again.');
                }
            }
        });
    }

    function updateVoiceButtonState(recording) {
        if (!voiceButton) return;
        
        if (recording) {
            voiceButton.textContent = 'üî¥';
            voiceButton.classList.add('recording');
            voiceButton.style.animation = 'pulse 1s infinite';
            voiceButton.title = 'Stop recording';
        } else {
            voiceButton.textContent = 'üé§';
            voiceButton.classList.remove('recording');
            voiceButton.style.animation = '';
            voiceButton.title = 'Voice input';
        }
    }

    // =====================
    // CHAT FUNCTIONALITY
    // =====================

    // Toggle chat
    chatToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isActive = chatContainer.classList.toggle('active');
        chatToggle.classList.toggle('active', isActive);
        
        if (isActive) {
            chatInput.focus();
            console.log('üí¨ Chat opened');
        } else {
            console.log('üí¨ Chat closed');
            // Stop recording if active
            if (isRecording) {
                window.aiAssistant.stopListening();
            }
        }
    });

    // Close chat
    closeButton.addEventListener('click', function(e) {
        e.stopPropagation();
        chatContainer.classList.remove('active');
        chatToggle.classList.remove('active');
        if (isRecording) {
            window.aiAssistant.stopListening();
        }
    });

    // Close when clicking outside
    document.addEventListener('click', function(e) {
        if (!chatContainer.contains(e.target) && !chatToggle.contains(e.target)) {
            if (chatContainer.classList.contains('active')) {
                chatContainer.classList.remove('active');
                chatToggle.classList.remove('active');
                if (isRecording) {
                    window.aiAssistant.stopListening();
                }
            }
        }
    });

    // Send message function
    async function sendMessage() {
        const message = chatInput.value.trim();
        
        if (!message) {
            console.warn('‚ö†Ô∏è Empty message');
            return;
        }

        console.log('üì§ Sending message:', message);

        // Disable input while processing
        chatInput.disabled = true;
        sendButton.disabled = true;
        if (voiceButton) voiceButton.disabled = true;

        // Add user message to chat
        addMessageToChat('user', message);
        
        // Clear input
        chatInput.value = '';

        // Show typing indicator
        showTypingIndicator();

        try {
            // Send to AI Assistant with selected language
            const response = await window.aiAssistant.sendMessage(message);
            
            console.log('üì• Received response:', response.substring(0, 50) + '...');
            
            // Hide typing indicator
            hideTypingIndicator();
            
            // Add AI response to chat
            addMessageToChat('assistant', response);
            
        } catch (error) {
            console.error('‚ùå Chat error:', error);
            hideTypingIndicator();
            addMessageToChat('assistant', '‚ö†Ô∏è Sorry, I encountered an error. Please try again.');
        } finally {
            // Re-enable input
            chatInput.disabled = false;
            sendButton.disabled = false;
            if (voiceButton) voiceButton.disabled = false;
            chatInput.focus();
        }
    }

    // Send button click
    sendButton.addEventListener('click', function(e) {
        e.preventDefault();
        sendMessage();
    });

    // Enter key to send
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Clear chat
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            chatMessages.innerHTML = '';
            window.aiAssistant.clearHistory();
            console.log('üóëÔ∏è Chat cleared');
            
            setTimeout(() => {
                const currentLang = languageSelect ? languageSelect.value : 'auto';
                const langName = getLanguageDisplayName(currentLang);
                addMessageToChat('assistant', `Chat cleared! I'll respond in ${langName}. How can I help you? üòä`);
            }, 100);
        });
    }

    // Add initial welcome message
    setTimeout(() => {
        const currentLang = languageSelect ? languageSelect.value : 'auto';
        const langName = getLanguageDisplayName(currentLang);
        const voiceStatus = window.aiAssistant.isSpeechAvailable() ? 'üé§ Voice input available' : '';
        
        addMessageToChat('assistant', 
            `Hello! I'm Zeno, your AI assistant. I'll respond in ${langName}. ${voiceStatus}\n\nAsk me anything about language learning! üöÄ`
        );
    }, 500);

    console.log('‚úÖ Chat UI initialized with language selection and voice input');
}

// =====================
// UTILITY FUNCTIONS
// =====================

function addMessageToChat(sender, message) {
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message`;
    
    const timestamp = new Date().toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const messageText = escapeHtml(message);
    
    messageDiv.innerHTML = `
        <div class="message-content">
            <div class="message-text">${messageText.replace(/\n/g, '<br>')}</div>
            <div class="message-time">${timestamp}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom smoothly
    chatMessages.scrollTo({
        top: chatMessages.scrollHeight,
        behavior: 'smooth'
    });
}

function showTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.style.display = 'block';
    }
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.style.display = 'none';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Test API connections on load
async function testAPIConnections() {
    console.log('üîç Testing API connections...');
    
    try {
        const status = await window.aiAssistant.getProvidersStatus();
        console.log('üìä API Status:', status);
        
        if (status.groq) {
            console.log('‚úÖ Groq API: Connected');
            window.aiAssistant.setProvider('groq');
        } else if (status.huggingface) {
            console.log('‚úÖ HuggingFace API: Connected');
            window.aiAssistant.setProvider('huggingface');
        } else if (status.ollama) {
            console.log('‚úÖ Ollama: Connected');
            window.aiAssistant.setProvider('ollama');
        } else {
            console.warn('‚ö†Ô∏è No API connections available');
        }
    } catch (error) {
        console.error('‚ùå API test failed:', error);
    }
}

// =====================
// INITIALIZATION
// =====================

// Initialize when AI Assistant is ready
waitForAIAssistant(() => {
    initializeChatUI();
    testAPIConnections();
});

// Also initialize on DOM ready (backup)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ DOM ready, waiting for AI Assistant...');
    });
} else {
    console.log('üìÑ DOM already ready');
}

console.log('‚úÖ Enhanced chat UI script loaded with language selection & voice input');
  </script>
<script type="module">
    
    
    try {
        // Dynamically import firebase-config.js and destructure exports
        const firebaseConfig = await import('../config/firebase-config.js');
        const {
            auth, db, googleProvider,
            signInWithPopup, onAuthStateChanged, signOut,
            doc, setDoc, getDoc, updateDoc
        } = firebaseConfig;

        // Import enhanced online modules
        const { default: authManager } = await import('../js/firebase-auth.js');
        const { default: pageManager } = await import('../js/page-connection.js');
        
        // Try to import dictionary with proper error handling
        let dictionary, translator;
        try {
            // Use the correct import syntax for named exports
            const dictModule = await import('../js/dictionary.js');
            dictionary = dictModule.dictionary;
            translator = dictModule.translator;
            console.log('‚úÖ Dictionary imported successfully:', dictionary);
        } catch (dictError) {
            console.error('‚ùå Dictionary import failed:', dictError);
            console.log('üîß Attempting alternative import method...');
            
            // Try alternative import method
            try {
                // Some bundlers might handle this differently
                const altDictModule = await import('../js/dictionary.js');
                if (altDictModule.default) {
                    dictionary = altDictModule.default.dictionary;
                    translator = altDictModule.default.translator;
                    console.log('‚úÖ Dictionary imported via default export');
                } else {
                    throw new Error('No default export found');
                }
            } catch (altError) {
                console.error('‚ùå Alternative import also failed:', altError);
                // Create minimal fallback dictionary
                dictionary = createFallbackDictionary();
                translator = createFallbackTranslator();
            }
            
        }
        
       
        const { default: progressAnalytics } = await import('../js/progress-analytics.js');
        const { default: aiAssistant } = await import('../js/ai-assistant.js');

        window.authManager = authManager;
        window.pageManager = pageManager;
        window.translator = translator;
        window.dictionary = dictionary;
        window.progressAnalytics = progressAnalytics;
        window.aiAssistant = aiAssistant;

        console.log('üöÄ All modules loaded successfully');
        console.log('üìñ Dictionary available:', !!window.dictionary);
        console.log('üåê Translator available:', !!window.translator);
        
    } catch (error) {
        console.error('‚ùå Critical error loading modules:', error);
        // Ensure basic dictionary function exists
        window.dictionary = createFallbackDictionary();
        window.translator = createFallbackTranslator();
    }

    try {
    // ... existing imports ...

    
    // Make globally available
    window.aiChatbot = aiChatbot;

    console.log('üöÄ All modules loaded successfully');
    console.log('ü§ñ AI Chatbot available:', !!window.aiChatbot);
    
} catch (error) {
    console.error('‚ùå Critical error loading modules:', error);
    // Fallback chatbot
    window.aiChatbot = createFallbackChatbot();
}

   </script>
<!-- Debug Script -->
<script>
// Check if dictionary.js is loading
console.log('üîß Checking dictionary.js availability...');

// Test if the file exists and can be fetched
fetch('../js/dictionary.js')
    .then(response => {
        if (response.ok) {
            console.log('‚úÖ dictionary.js file exists and is accessible');
            return response.text();
        } else {
            console.error('‚ùå dictionary.js file not found or inaccessible');
        }
    })
    .then(text => {
        if (text) {
            console.log('üìÑ dictionary.js content length:', text.length);
            // Check if exports are in the file
            if (text.includes('export { dictionary, translator }')) {
                console.log('‚úÖ Correct exports found in dictionary.js');
            } else {
                console.error('‚ùå Correct exports NOT found in dictionary.js');
            }
        }
    })
    .catch(error => {
        console.error('‚ùå Failed to fetch dictionary.js:', error);
    });

// Check current window state
setTimeout(() => {
    console.log('ü™ü Window dictionary state:', window.dictionary);
    console.log('ü™ü Window translator state:', window.translator);
}, 2000);
</script>

  

<script>
    // Enhanced Home Page Initialization - Replace the existing initialization section

// Make functions globally available IMMEDIATELY
window.openModule = async function(moduleName) {
    console.log('üìÇ Opening module:', moduleName);
    
    try {
        // Ensure we have user data before navigating
        if (!userProfile || !userProfile.userId) {
            await loadUserData();
        }
        
        // Add parameters to track progress
        const params = new URLSearchParams({
            userId: userProfile.userId,
            targetLang: userProfile.targetLanguage,
            teachingLang: userProfile.teachingLanguage
        });
        
        window.location.href = `${moduleName}-ai.html?${params.toString()}`;
        
    } catch (error) {
        console.error('‚ùå Error preparing module:', error);
        // Fallback navigation
        window.location.href = `${moduleName}-ai.html`;
    }
};


window.continueLearning = function() {
    console.log('üìö Continue learning clicked');
    const modules = ['alphabets', 'vocabulary', 'grammar', 'assessment'];
    
    for (const module of modules) {
        const card = document.querySelector(`[onclick="openModule('${module}')"]`);
        if (card && !card.classList.contains('locked')) {
            window.openModule(module);
            return;
        }
    }
    
    alert('All modules completed! üéâ');
};


// Global settings state
let isProcessingSettings = false;

// ========================================
// OPEN SETTINGS MODAL
// ========================================
window.openSettings = async function() {
    console.log('‚öôÔ∏è Opening settings modal...');
    
    const modal = document.getElementById('settingsModal');
    if (!modal) {
        console.error('‚ùå Settings modal not found');
        return;
    }
    
    // Load current profile data
    try {
        let profile = userProfile;
        
        // Try to get latest from Firebase
        if (window.currentUser && window.db) {
            const userRef = window.doc(window.db, 'users', window.currentUser.uid);
            const userDoc = await window.getDoc(userRef);
            
            if (userDoc.exists()) {
                profile = userDoc.data();
                console.log('‚úÖ Loaded latest profile from Firebase');
            }
        }
        
        // Populate form with current values
        const teachingSelect = document.getElementById('teachingLanguageSelect');
        const targetSelect = document.getElementById('targetLanguageSelect');
        
        if (teachingSelect && profile.teachingLanguage) {
            teachingSelect.value = profile.teachingLanguage;
        }
        
        if (targetSelect && profile.targetLanguage) {
            targetSelect.value = profile.targetLanguage;
        }
        
        console.log('üìù Form populated with current settings:', {
            teaching: profile.teachingLanguage,
            target: profile.targetLanguage
        });
        
    } catch (error) {
        console.error('‚ùå Error loading settings:', error);
    }
    
    // Show modal
    modal.style.display = 'flex';
    modal.classList.add('active');
};

// ========================================
// CLOSE SETTINGS MODAL
// ========================================
window.closeSettings = function() {
    console.log('‚ùå Closing settings modal...');
    
    const modal = document.getElementById('settingsModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
    }
};

// ========================================
// SAVE LANGUAGE SETTINGS
// ========================================
window.saveSettings = async function() {
    if (isProcessingSettings) {
        console.log('‚è≥ Already processing settings...');
        return;
    }
    
    console.log('üíæ Saving language settings...');
    isProcessingSettings = true;
    
    try {
        // Get selected languages
        const teachingLang = document.getElementById('teachingLanguageSelect')?.value;
        const targetLang = document.getElementById('targetLanguageSelect')?.value;
        
        // Validation
        if (!teachingLang || !targetLang) {
            alert('‚ö†Ô∏è Please select both languages');
            isProcessingSettings = false;
            return;
        }
        
        if (teachingLang === targetLang) {
            alert('‚ö†Ô∏è Teaching and target languages must be different!\n\nYour native language and the language you want to learn should not be the same.');
            isProcessingSettings = false;
            return;
        }
        
        // Check if actually changed
        const currentTeaching = userProfile?.teachingLanguage;
        const currentTarget = userProfile?.targetLanguage;
        
        if (teachingLang === currentTeaching && targetLang === currentTarget) {
            console.log('‚ÑπÔ∏è No changes detected');
            alert('‚ÑπÔ∏è No changes were made to your language settings.');
            window.closeSettings();
            isProcessingSettings = false;
            return;
        }
        
        // Show loading state
        const saveBtn = document.querySelector('#settingsModal .btn-primary');
        const originalText = saveBtn?.textContent;
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';
        }
        
        // Update local profile
        const oldTeachingLang = userProfile.teachingLanguage;
        const oldTargetLang = userProfile.targetLanguage;
        
        userProfile.teachingLanguage = teachingLang;
        userProfile.targetLanguage = targetLang;
        userProfile.lastModified = new Date().toISOString();
        
        console.log('üìù Language settings updated:', {
            teaching: `${getLanguageName(oldTeachingLang)} ‚Üí ${getLanguageName(teachingLang)}`,
            target: `${getLanguageName(oldTargetLang)} ‚Üí ${getLanguageName(targetLang)}`
        });
        
        // Save to Firebase
        if (window.currentUser && window.db) {
            try {
                const userRef = window.doc(window.db, 'users', window.currentUser.uid);
                await window.updateDoc(userRef, {
                    teachingLanguage: teachingLang,
                    targetLanguage: targetLang,
                    lastModified: new Date().toISOString()
                });
                
                console.log('‚úÖ Language settings saved to Firebase');
            } catch (firebaseError) {
                console.error('‚ùå Firebase update error:', firebaseError);
                throw new Error('Failed to save to cloud: ' + firebaseError.message);
            }
        }
        
        // Save to all storage locations
        sessionStorage.setItem('userProfile', JSON.stringify(userProfile));
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        
        console.log('‚úÖ Language settings saved to all storage locations');
        
        // Update UI immediately
        updateUIWithProfile(userProfile);
        
        // Update page language attribute if needed
        document.documentElement.setAttribute('data-teaching-language', teachingLang);
        
        // Close modal
        window.closeSettings();
        
        // Show success message
        showSuccessNotification(
            `‚úÖ Language Settings Updated!\n\n` +
            `Native Language: ${getLanguageName(teachingLang)}\n` +
            `Learning: ${getLanguageName(targetLang)}\n\n` +
            `Your entire experience will now adapt to these languages.`
        );
        
        // Optional: Reload page after short delay to apply changes everywhere
        setTimeout(() => {
            const shouldReload = confirm(
                'üîÑ Reload page to apply changes?\n\n' +
                'This will ensure all modules use your new language settings.'
            );
            
            if (shouldReload) {
                window.location.reload();
            }
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Error saving settings:', error);
        alert('‚ùå Failed to save settings: ' + error.message + '\n\nPlease try again.');
        
        // Restore button
        const saveBtn = document.querySelector('#settingsModal .btn-primary');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
        }
    } finally {
        isProcessingSettings = false;
    }
};


function showSuccessNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        font-size: 16px;
        line-height: 1.6;
        white-space: pre-line;
        animation: slideIn 0.5s ease-out;
    `;
    
    notification.textContent = message;
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease-in';
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}
window.logout = function() {
    console.log('üëã Logging out');
    sessionStorage.clear();
    localStorage.removeItem('userAuthenticated');
    localStorage.removeItem('userProfile');
    
    if (window.authManager) {
        window.authManager.signOutUser();
    } else {
        window.location.href = 'botinteraction.html';
    }
};

window.openPractice = function() {
    alert('Practice mode coming soon! üéØ');
};

window.openProgressAnalytics = function() {
    alert('Progress analytics coming soon! üìä');
};

window.openDictionary = function() {
    console.log('üìñ Opening dictionary...');
    
    if (window.dictionary && typeof window.dictionary.openDictionary === 'function') {
        window.dictionary.openDictionary();
    } else {
        console.error('‚ùå Dictionary not available');
        alert('Dictionary is loading... Please try again in a moment.');
    }
};

// Global state
let userProfile = null;
let userProgress = null;
let initializationComplete = false;




// ENHANCED: Initialize home page with better profile loading
async function initializeHomePage() {
    if (initializationComplete) {
        console.log('‚ö†Ô∏è Already initialized');
        return;
    }
    
    console.log('üè† Initializing home page...');
    
    try {
        // Check authentication
        const fromBotInteraction = sessionStorage.getItem('fromBotInteraction');
        const profileSetupComplete = sessionStorage.getItem('profileSetupComplete');
        
        if (fromBotInteraction && profileSetupComplete) {
            console.log('üÜï New user from bot interaction');
            await handleNewUserSetup();
            return;
        }
        
        const isAuthenticated = await checkAuthentication();
        if (isAuthenticated) {
            console.log('‚úÖ Authenticated user, loading data...');
            await loadUserData();
            
            // Load journey progress
            await initializeProgressTracker();
await loadJourneyProgress();
            
            document.getElementById('authOverlay')?.classList.add('hidden');
        } else {
            console.log('‚ùå Not authenticated, redirecting...');
            window.location.href = 'botinteraction.html';
            return;
        }
        
        initializePageFeatures();
        initializationComplete = true;
        
    } catch (error) {
        console.error('‚ùå Initialization error:', error);
        document.getElementById('authOverlay')?.classList.remove('hidden');
    }
}

// NEW FUNCTION: Load and display journey progress
// ENHANCED: Load and display journey progress with better error handling
// ENHANCED: Initialize progress tracker after user data loads
async function initializeProgressTracker() {
    console.log('üéØ Initializing progress tracker integration...');
    
    try {
        if (!userProfile || !userProfile.userId) {
            console.warn('‚ö†Ô∏è No user profile for progress tracker');
            return;
        }

        // Ensure tracker is loaded
        if (!window.tracker) {
            console.error('‚ùå Progress tracker not loaded');
            return;
        }

        // Initialize tracker with user ID
        await window.tracker.initialize(userProfile.userId);
        
        console.log('‚úÖ Progress tracker initialized successfully');
        
        // Update module cards based on progress
        updateModuleCardsFromTracker();
        
    } catch (error) {
        console.error('‚ùå Failed to initialize progress tracker:', error);
    }
}

// NEW: Update module cards from tracker data
function updateModuleCardsFromTracker() {
    if (!window.tracker) return;
    
    const moduleNames = ['alphabets', 'vocabulary', 'grammar', 'assessment'];
    
    moduleNames.forEach(moduleName => {
        const card = document.querySelector(`[onclick="openModule('${moduleName}')"]`);
        if (!card) return;
        
        const progress = window.tracker.getModuleProgress(moduleName);
        const completed = window.tracker.isModuleComplete(moduleName);
        
        // Remove all status classes
        card.classList.remove('completed', 'current', 'locked');
        
        // Update based on progress
        if (completed) {
            card.classList.add('completed');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = '‚úÖ Completed';
                statusEl.className = 'module-status status-completed';
            }
        } else if (progress > 0) {
            card.classList.add('current');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = `üìç ${progress}% Complete`;
                statusEl.className = 'module-status status-current';
            }
        } else {
            card.classList.add('current');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = 'üìç Available';
                statusEl.className = 'module-status status-current';
            }
        }
    });
    
    console.log('‚úÖ Module cards updated from tracker');
}

// REPLACE your current loadJourneyProgress function with this:
async function loadJourneyProgress() {
    console.log('üìä Loading journey progress...');
    
    try {
        // Initialize progress tracker (this loads from Firebase)
        await initializeProgressTracker();
        
        // Optionally load additional journey data
        if (userProfile && userProfile.userId && window.learningEngine) {
            const journeyResult = await window.learningEngine.getUserJourneyWithCache(userProfile.userId);
            
            if (journeyResult.success && journeyResult.data) {
                const journey = journeyResult.data;
                
                // Update stats that aren't handled by tracker
                updateProgressStats(journey);
                
                console.log('‚úÖ Full journey data loaded');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error loading journey progress:', error);
        // Tracker will use session storage fallback
    }
}

// NEW: Fallback progress when journey loading fails
function showFallbackProgress() {
    console.log('üîÑ Showing fallback progress data');
    
    const fallbackJourney = {
        overallProgress: userProfile?.progress?.overall || 0,
        modules: {
            alphabets: { completed: false, progress: 0, lessonsCompleted: [] },
            vocabulary: { completed: false, progress: 0, lessonsCompleted: [] },
            grammar: { completed: false, progress: 0, lessonsCompleted: [] },
            assessment: { completed: false, progress: 0, lessonsCompleted: [] }
        },
        totalTimeSpent: userProfile?.progress?.totalTime || 0,
        currentStreak: userProfile?.gamification?.streak || 1
    };
    
    updateProgressUI(fallbackJourney);
}

// NEW: Dedicated UI update function
function updateProgressUI(journey) {
    // Update progress bar
    const overallProgress = journey.overallProgress || 0;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('overallProgress');
    
    if (progressFill) {
        progressFill.style.width = `${overallProgress}%`;
        progressFill.style.transition = 'width 0.5s ease-in-out';
    }
    
    if (progressText) {
        progressText.textContent = `${overallProgress}%`;
    }

    // Update module cards with progress
    updateModuleCardsWithProgress(journey.modules);

    // Update stats
    updateProgressStats(journey);

    console.log('‚úÖ Progress UI updated successfully');
}

// DEBUG: Test journey operations
window.debugJourney = async function() {
    console.group('üîß Journey Debug Information');
    
    if (!userProfile?.userId) {
        console.error('‚ùå No user profile found');
        return;
    }
    
    try {
        // Test Firebase connection
        console.log('üß™ Testing Firebase connection...');
        const userRef = window.doc(window.db, 'users', userProfile.userId);
        const userDoc = await window.getDoc(userRef);
        console.log('‚úÖ Firebase connection:', userDoc.exists() ? 'Working' : 'No user doc');
        
        // Test learning engine
        console.log('üß™ Testing learning engine...');
        if (!window.learningEngine) {
            console.error('‚ùå Learning engine not loaded');
            return;
        }
        
        const testResult = await window.learningEngine.getUserJourneyWithCache(userProfile.userId);
        console.log('‚úÖ Learning engine test:', testResult.success ? 'Working' : 'Failed', testResult);
        
        // Test journey creation
        if (!testResult.success) {
            console.log('üß™ Testing journey creation...');
            const createResult = await window.learningEngine.initializeUserJourney(
                userProfile.userId,
                userProfile.targetLanguage,
                userProfile.teachingLanguage
            );
            console.log('‚úÖ Journey creation:', createResult.success ? 'Working' : 'Failed', createResult);
        }
        
    } catch (error) {
        console.error('‚ùå Debug test failed:', error);
    }
    
    console.groupEnd();
};

// DEBUG: Force reset journey
window.resetJourney = async function() {
    if (!confirm('Are you sure you want to reset your journey progress? This cannot be undone.')) {
        return;
    }
    
    try {
        if (window.learningEngine && userProfile?.userId) {
            // Clear cache
            localStorage.removeItem(`userJourney_${userProfile.userId}`);
            
            // Reinitialize journey
            const result = await window.learningEngine.initializeUserJourney(
                userProfile.userId,
                userProfile.targetLanguage,
                userProfile.teachingLanguage
            );
            
            if (result.success) {
                alert('‚úÖ Journey reset successfully!');
                await loadJourneyProgress();
            } else {
                alert('‚ùå Failed to reset journey: ' + result.error);
            }
        }
    } catch (error) {
        console.error('Reset failed:', error);
        alert('Reset failed: ' + error.message);
    }
};


// NEW FUNCTION: Update module cards with actual progress
function updateModuleCardsWithProgress(modules) {
    console.log('üéØ Updating module cards with progress data');
    
    const moduleNames = ['alphabets', 'vocabulary', 'grammar', 'assessment'];
    
    moduleNames.forEach(moduleName => {
        const card = document.querySelector(`[onclick="openModule('${moduleName}')"]`);
        if (!card) return;
        
        const moduleData = modules[moduleName] || { completed: false, progress: 0, lessonsCompleted: [] };
        
        // Remove all status classes
        card.classList.remove('completed', 'current', 'locked');
        
        // Update based on actual progress
        if (moduleData.completed) {
            card.classList.add('completed');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = '‚úÖ Completed';
                statusEl.className = 'module-status status-completed';
            }
        } else if (moduleData.progress > 0) {
            card.classList.add('current');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = `üìç ${moduleData.progress}% Complete`;
                statusEl.className = 'module-status status-current';
            }
        } else {
            card.classList.add('current');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = 'üìç Available';
                statusEl.className = 'module-status status-current';
            }
        }
        
        console.log(`‚úÖ Updated ${moduleName}: ${moduleData.progress}% (${moduleData.lessonsCompleted.length} lessons)`);
    });
}

// NEW FUNCTION: Update progress statistics
function updateProgressStats(journey) {
    // These stats are not part of the progress tracker
    // but come from the learning journey
    
    // Update time spent
    const timeEl = document.getElementById('timeLearned');
    if (timeEl && journey.totalTimeSpent) {
        const hours = Math.floor(journey.totalTimeSpent / 60);
        const minutes = journey.totalTimeSpent % 60;
        timeEl.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    }

    // Update current streak
    const streakEl = document.getElementById('currentStreak');
    if (streakEl) {
        const streak = journey.currentStreak || userProfile?.gamification?.streak || 1;
        streakEl.textContent = streak;
    }
    
    // Update lessons completed
    let totalCompleted = 0;
    if (journey.modules) {
        Object.values(journey.modules).forEach(mod => {
            totalCompleted += mod.lessonsCompleted?.length || 0;
        });
    }
    
    const lessonsEl = document.getElementById('lessonsCompleted');
    if (lessonsEl) {
        lessonsEl.textContent = totalCompleted;
    }
}
async function handleNewUserSetup() {
    console.log('üë§ Setting up new user profile...');
    
    // Clear navigation flags
    sessionStorage.removeItem('fromBotInteraction');
    sessionStorage.removeItem('profileSetupComplete');
    sessionStorage.removeItem('justLoggedIn');
    
    // Load profile from session storage (saved by bot interaction)
    const storedProfile = sessionStorage.getItem('userProfile');
    
    if (!storedProfile) {
        console.error('‚ùå No profile found in session storage!');
        alert('Profile setup incomplete. Please complete the setup process.');
        window.location.href = 'botinteraction.html';
        return;
    }
    
    try {
        userProfile = JSON.parse(storedProfile);
        console.log('‚úÖ Profile loaded from bot interaction:', userProfile);
        
        // Verify all required fields exist
        if (!userProfile.userId || !userProfile.targetLanguage || !userProfile.teachingLanguage) {
            throw new Error('Incomplete profile data');
        }
        
        // Update UI immediately with bot interaction data
        updateUIWithProfile(userProfile);
        updateProgressDisplay(userProfile);
        
        // Hide auth overlay
        document.getElementById('authOverlay')?.classList.add('hidden');
        
        // Initialize features
        initializePageFeatures();
        
        // Show welcome message
        setTimeout(() => {
            showWelcomeMessage(userProfile);
        }, 1000);
        
        initializationComplete = true;
        
    } catch (error) {
        console.error('‚ùå Error parsing profile:', error);
        alert('Profile data corrupted. Please set up again.');
        window.location.href = 'botinteraction.html';
    }
}

function showWelcomeMessage(profile) {
    // Optional: Show a welcome popup for new users
    const welcomeMsg = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    z-index: 10000; text-align: center; max-width: 400px;">
            <h2 style="margin: 0 0 15px 0; color: #666;">üéâ Welcome, ${profile.displayName}!</h2>
            <p style="margin: 0 0 20px 0; color: #666;">Your learning journey begins now!</p>
            <p style="margin: 0 0 20px 0; color: #666;">
                Learning: <strong>${getLanguageName(profile.targetLanguage)}</strong><br>
                Teaching Language: <strong>${getLanguageName(profile.teachingLanguage)}</strong>
            </p>
            <button onclick="this.parentElement.remove()" 
                    style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; 
                           border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; 
                           cursor: pointer; font-weight: 600;">
                Start Learning! üöÄ
            </button>
        </div>
        <div onclick="this.nextElementSibling.remove(); this.remove();" 
             style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 9999;"></div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', welcomeMsg);
}

async function checkAuthentication() {
    // Check multiple authentication sources
    if (window.authManager?.currentUser) return true;
    if (window.auth?.currentUser) return true;
    if (localStorage.getItem('userAuthenticated') === 'true') return true;
    
    // Check session storage for recent login
    if (sessionStorage.getItem('userProfile')) {
        const profile = JSON.parse(sessionStorage.getItem('userProfile'));
        if (profile.userId) return true;
    }
    
    return false;
}

async function loadUserData() {
    try {
        console.log('üìã Loading user data from multiple sources...');
        
        let profileLoaded = false;
        
        // Priority 1: Session storage (most recent)
        const sessionProfile = sessionStorage.getItem('userProfile');
        if (sessionProfile) {
            try {
                userProfile = JSON.parse(sessionProfile);
                console.log('‚úÖ Profile loaded from session storage');
                profileLoaded = true;
            } catch (e) {
                console.warn('Session storage parse error');
            }
        }
        
        // Priority 2: Local storage (backup)
        if (!profileLoaded) {
            const localProfile = localStorage.getItem('userProfile');
            if (localProfile) {
                try {
                    userProfile = JSON.parse(localProfile);
                    console.log('‚úÖ Profile loaded from local storage');
                    profileLoaded = true;
                } catch (e) {
                    console.warn('Local storage parse error');
                }
            }
        }
        
        // Priority 3: Firebase (authoritative source)
        if (window.auth?.currentUser) {
            try {
                const userRef = doc(window.db, 'users', window.auth.currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const firebaseData = userDoc.data();
                    // Merge with existing profile or replace
                    userProfile = profileLoaded ? 
                        { ...userProfile, ...firebaseData } : 
                        firebaseData;
                    
                    console.log('‚úÖ Profile synced with Firebase');
                    profileLoaded = true;
                    
                    // Update storage with latest data
                    sessionStorage.setItem('userProfile', JSON.stringify(userProfile));
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
            } catch (firebaseError) {
                console.error('‚ùå Firebase load error:', firebaseError);
            }
        }
        
        // Priority 4: Auth manager
        if (!profileLoaded && window.authManager?.currentUser) {
            try {
                const authProfile = await window.authManager.getUserProfile();
                if (authProfile) {
                    userProfile = authProfile;
                    console.log('‚úÖ Profile loaded from auth manager');
                    profileLoaded = true;
                }
            } catch (e) {
                console.warn('Auth manager load error:', e);
            }
        }
        
        if (!userProfile || !userProfile.userId) {
            console.error('‚ùå No user profile found after all attempts');
            throw new Error('Profile not found');
        }
        
        console.log('‚úÖ Final user profile loaded:', {
            userId: userProfile.userId,
            displayName: userProfile.displayName,
            targetLanguage: userProfile.targetLanguage,
            teachingLanguage: userProfile.teachingLanguage
        });
        
        // Update UI with loaded profile
        updateUIWithProfile(userProfile);
        updateProgressDisplay(userProfile);
        
    } catch (error) {
        console.error('‚ùå Error loading user data:', error);
        // If we can't load profile, redirect to setup
        if (!sessionStorage.getItem('fromBotInteraction')) {
            alert('Unable to load your profile. Please complete setup again.');
            window.location.href = 'botinteraction.html';
        }
    }
}

function updateUIWithProfile(profile) {
    console.log('üé® Updating UI with profile...');
    
    const elements = {
        welcomeName: profile.displayName || profile.userName || 'Friend',
        userName: profile.displayName || profile.userName || 'Language Learner',
        targetLang: getLanguageName(profile.targetLanguage),
        teachingLang: getLanguageName(profile.teachingLanguage),
        userLevel: profile.level || 'Beginner',
        daysLearning: profile.progress?.daysLearning || 1
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = value;
            console.log(`‚úÖ Updated ${id}: ${value}`);
        }
    });
    
    // Update avatar
    const avatarEl = document.getElementById('userAvatar');
    if (avatarEl && profile.photoURL) {
        avatarEl.src = profile.photoURL;
        console.log('‚úÖ Updated avatar');
    }
    
    // Update subtitle with personalized message
    const subtitleEl = document.getElementById('welcomeSubtitle');
    if (subtitleEl) {
        subtitleEl.textContent = `Continue your ${getLanguageName(profile.targetLanguage)} learning journey with Zeno`;
    }
}

function updateProgressDisplay(profile) {
    console.log('üìä Updating progress display from profile...');
    
    // This is called on initial load, but journey progress takes priority
    // We'll load journey progress after this
    setTimeout(() => {
        if (profile.userId) {
            loadJourneyProgress();
        }
    }, 500);
    
    // Update basic gamification data
    const gamification = profile.gamification || {};
    
    const updates = {
        pointsEarned: (gamification.totalPoints || gamification.xp || 0).toLocaleString()
    };
    
    Object.entries(updates).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = value;
        }
    });
    
    // Update badges
    updateBadgesDisplay(gamification.badges || ['first_steps']);
}

// Add a refresh button handler
window.refreshProgress = async function() {
    console.log('üîÑ Manually refreshing progress...');
    
    // Clear cache
    if (userProfile?.userId) {
        localStorage.removeItem(`userJourney_${userProfile.userId}`);
    }
    
    // Reload progress
    await loadJourneyProgress();
    
    alert('‚úÖ Progress refreshed!');
};
// REPLACE the updateModuleCards function in home-ai.html (around line 450)



function updateModuleCards(modules) {
    console.log('üéØ Updating module cards...');
    
    const moduleNames = ['alphabets', 'vocabulary', 'grammar', 'assessment'];
    
    moduleNames.forEach(moduleName => {
        const card = document.querySelector(`[onclick="openModule('${moduleName}')"]`);
        if (!card) return;
        
        const moduleData = modules[moduleName] || { completed: false, locked: false };
        
        // Remove all status classes
        card.classList.remove('completed', 'current', 'locked');
        
        // All modules are always accessible
        if (moduleData.completed) {
            card.classList.add('completed');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = '‚úÖ Completed';
                statusEl.className = 'module-status status-completed';
            }
        } else {
            card.classList.add('current');
            const statusEl = card.querySelector('.module-status');
            if (statusEl) {
                statusEl.textContent = 'üìç Available';
                statusEl.className = 'module-status status-current';
            }
        }
        
        console.log(`‚úÖ Updated ${moduleName} card status: ${moduleData.completed ? 'completed' : 'available'}`);
    });
}


function updateBadgesDisplay(badges) {
    console.log('üèÜ Updating badges...');
    
    const badgeElements = document.querySelectorAll('.badge');
    
    badgeElements.forEach(badgeEl => {
        const badgeId = badgeEl.dataset.badge;
        if (badges.includes(badgeId)) {
            badgeEl.classList.remove('not-earned');
            badgeEl.classList.add('earned');
        } else {
            badgeEl.classList.remove('earned');
            badgeEl.classList.add('not-earned');
        }
    });
    
    console.log(`‚úÖ Updated ${badges.length} earned badges`);
}

function formatTime(minutes) {
    if (minutes < 60) {
        return `${minutes}m`;
    }
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
}

function initializePageFeatures() {
    console.log('üéØ Initializing page features...');
    
    // Initialize gamification
    setTimeout(() => {
        try {
            if (window.gamification) {
                window.gamification.updateStreak();
                console.log('‚úÖ Gamification initialized');
            }
        } catch (error) {
            console.warn('Gamification error:', error);
        }
    }, 500);
    
    // Load AI recommendations
    setTimeout(() => {
        loadAIRecommendations();
    }, 1000);
    
    // Initialize AI Assistant (Zeno)
    setTimeout(() => {
        initializeAIAssistant();
    }, 1500);
}

function initializeAIAssistant() {
    console.log('ü§ñ Initializing AI Assistant...');
    
    if (window.aiAssistant) {
      
        
        console.log('‚úÖ AI Assistant ready (fallback mode - add API key for full AI features)');
    } else {
        console.warn('‚ö†Ô∏è AI Assistant not loaded');
    }
}

async function loadAIRecommendations() {
    try {
        console.log('üß† Loading AI recommendations...');
        
        if (window.progressAnalytics) {
            const recommendations = await window.progressAnalytics.getPersonalizedRecommendations();
            displayAIRecommendations(recommendations);
        } else {
            displayFallbackRecommendations();
        }
    } catch (error) {
        console.warn('Recommendations failed:', error);
        displayFallbackRecommendations();
    }
}

function displayAIRecommendations(recommendations) {
    const container = document.getElementById('aiRecommendations');
    if (!container) return;
    
    let recs = recommendations.immediate || [];
    if (!Array.isArray(recs)) recs = [];
    
    if (recs.length === 0) {
        displayFallbackRecommendations();
        return;
    }
    
    container.innerHTML = recs.slice(0, 3).map(rec => `
        <div class="recommendation-card">
            <div class="rec-icon">üéØ</div>
            <div class="rec-content">
                <h4>AI Recommendation</h4>
                <p>${typeof rec === 'string' ? rec : rec.text || 'Continue learning'}</p>
            </div>
        </div>
    `).join('');
}

function displayFallbackRecommendations() {
    const container = document.getElementById('aiRecommendations');
    if (!container) return;
    
    const targetLang = userProfile?.targetLanguage || 'your target language';
    
    container.innerHTML = `
        <div class="recommendation-card">
            <div class="rec-icon">üéØ</div>
            <div class="rec-content">
                <h4>Focus Area</h4>
                <p>Start with the Alphabets module to build a strong foundation in ${getLanguageName(targetLang)}</p>
            </div>
        </div>
        <div class="recommendation-card">
            <div class="rec-icon">‚è∞</div>
            <div class="rec-content">
                <h4>Daily Goal</h4>
                <p>Practice for 15-30 minutes daily for optimal learning progress</p>
            </div>
        </div>
        <div class="recommendation-card">
            <div class="rec-icon">üìà</div>
            <div class="rec-content">
                <h4>Learning Tip</h4>
                <p>Consistency is key! Try to maintain your learning streak every day</p>
            </div>
        </div>
    `;
}

function getLanguageName(code) {
    const languages = {
        'en': 'English',
        'ta': 'Tamil',
        'hi': 'Hindi',
        'fr': 'French',
        'de': 'German'
    };
    return languages[code] || code;
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('settingsModal');
    if (e.target === modal) {
        window.closeSettings();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('settingsModal');
        if (modal && modal.style.display === 'flex') {
            window.closeSettings();
        }
    }
});

console.log('‚úÖ Enhanced settings system loaded');
console.log('üìù Features: Language change + Profile deletion');

// Google Sign In (if needed)
document.getElementById('googleSignInBtn')?.addEventListener('click', async () => {
    if (!window.authManager) {
        alert('Authentication system not ready');
        return;
    }
    
    const result = await window.authManager.signInWithGoogle();
    if (!result.success) {
        alert(result.error || 'Sign in failed');
    }
});

// Initialize when ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeHomePage);
} else {
    initializeHomePage();
}


console.log('‚úÖ Home page script loaded and ready');
</script>

<script type="module">
    
import AIAssistant from '../js/ai-assistant.js';

const ai = new AIAssistant();
const chatContainer = document.getElementById('chatContainer');
const input = document.getElementById('chatInput');
const sendBtn = document.getElementById('chatSend');

// Choose provider dynamically
// ai.apiProvider = 'groq'; // or 'ollama' for offline mode

sendBtn.addEventListener('click', () => ai.handleUserInput(input, chatContainer));
input.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') ai.handleUserInput(input, chatContainer);
});
</script>

<script>
    // Add this to home-ai.html after the initializeHomePage function

// Check if returning from module page with refresh flag
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('refresh') === 'true') {
    console.log('üîÑ Refresh flag detected, will reload progress');
    
    // Clear refresh flag from URL
    window.history.replaceState({}, document.title, window.location.pathname);
    
    // Force progress reload after page loads
    window.addEventListener('load', () => {
        setTimeout(async () => {
            console.log('üîÑ Auto-refreshing progress after module completion...');
            if (userProfile?.userId) {
                // Clear cache
                localStorage.removeItem(`userJourney_${userProfile.userId}`);
                // Reload
                await loadJourneyProgress();
                
                // Show success notification
                showProgressUpdateNotification();
            }
        }, 1000);
    });
}

// NEW: Show visual notification when progress updates

// Call addRefreshButton after page initialization
setTimeout(() => {
    if (document.readyState === 'complete') {
        addRefreshButton();
    }
}, 2000);

// NEW: Periodic auto-refresh (every 30 seconds when page is active)
let progressRefreshInterval = null;

function startProgressAutoRefresh() {
    // Clear any existing interval
    if (progressRefreshInterval) {
        clearInterval(progressRefreshInterval);
    }
    
    // Refresh every 30 seconds if page is visible
    progressRefreshInterval = setInterval(async () => {
        if (!document.hidden && userProfile?.userId) {
            console.log('üîÑ Auto-refreshing progress (periodic)...');
            await loadJourneyProgress();
        }
    }, 30000); // 30 seconds
    
    console.log('‚úÖ Auto-refresh enabled (every 30 seconds)');
}

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('‚è∏Ô∏è Page hidden, pausing auto-refresh');
        if (progressRefreshInterval) {
            clearInterval(progressRefreshInterval);
        }
    } else {
        console.log('‚ñ∂Ô∏è Page visible, resuming auto-refresh');
        startProgressAutoRefresh();
        // Immediate refresh when page becomes visible again
        if (userProfile?.userId) {
            loadJourneyProgress();
        }
    }
});

// Start auto-refresh when page loads
window.addEventListener('load', () => {
    setTimeout(() => {
        startProgressAutoRefresh();
    }, 5000); // Start after 5 seconds
});

// Clear interval when page unloads
window.addEventListener('beforeunload', () => {
    if (progressRefreshInterval) {
        clearInterval(progressRefreshInterval);
    }
});
window.reloadLearningEngine = async function() {
    delete window.learningEngine;
    const { default: learningEngine } = await import('../js/learning-engine.js');
    window.learningEngine = learningEngine;
    console.log('‚úÖ Learning engine reloaded');
    await loadJourneyProgress();
};
console.log('‚úÖ Progress auto-refresh mechanism loaded');
</script>



<!-- Translation Widget - Direct Integration -->
<!-- Translation Widget -->
   <div class="translation-widget">
       <button class="translate-btn" id="translateBtn" title="Translate page">
           <span class="tooltip" id="tooltip">Translate to native language</span>
           <span id="btnIcon">üåê</span>
           <span class="language-label" id="langLabel">EN</span>
       </button>
   </div>


   <script src="../components/translation-widget.js"></script>


  


      <!-- ================================================ -->
<!-- PRACTICE MODE INTEGRATION FOR home-ai.html -->
<!-- ================================================ -->
<!-- Add this script AFTER the AI Assistant import -->

<script type="module">
// Import the practice mode module
import practiceMode from '../js/practice-mode.js';

// Make it globally available (if not already done in the module)
window.practiceMode = practiceMode;

console.log('‚úÖ Practice mode integrated into home page');
</script>

<!-- ================================================ -->
<!-- UPDATE THE openPractice FUNCTION -->
<!-- ================================================ -->
<!-- Replace the existing window.openPractice function with: -->

<script>
// Enhanced Practice Mode Function
window.openPractice = function() {
    console.log('üéØ Opening practice mode...');
    
    // Check if practice mode is loaded
    if (window.practiceMode && typeof window.practiceMode.openPracticeMode === 'function') {
        window.practiceMode.openPracticeMode();
    } else {
        console.error('‚ùå Practice mode not loaded');
        
        // Fallback: Show loading message and retry
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
        `;
        loadingMsg.innerHTML = `
            <h3>üéØ Loading Practice Mode...</h3>
            <p>Please wait a moment</p>
            <div style="margin-top: 20px;">
                <div class="spinner"></div>
            </div>
        `;
        document.body.appendChild(loadingMsg);
        
        // Retry after 2 seconds
        setTimeout(() => {
            loadingMsg.remove();
            
            if (window.practiceMode) {
                window.practiceMode.openPracticeMode();
            } else {
                alert('‚ö†Ô∏è Practice mode is still loading. Please try again in a moment.');
            }
        }, 2000);
    }
};

// Add spinner CSS if not already present
if (!document.querySelector('#practice-spinner-styles')) {
    const spinnerStyles = document.createElement('style');
    spinnerStyles.id = 'practice-spinner-styles';
    spinnerStyles.textContent = `
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(spinnerStyles);
}
</script>

<!-- ================================================ -->
<!-- ENHANCED PRACTICE BUTTON -->
<!-- ================================================ -->
<!-- Optionally enhance the Practice Mode button in your Quick Actions section: -->



<script>
// Add pulsing effect to practice button on page load
window.addEventListener('load', () => {
    setTimeout(() => {
        const practiceBtns = document.querySelectorAll('.action-btn');
        practiceBtns.forEach(btn => {
            if (btn.textContent.includes('Practice')) {
                btn.classList.add('practice-btn-pulse');
                
                // Remove pulse after user clicks
                btn.addEventListener('click', () => {
                    btn.classList.remove('practice-btn-pulse');
                }, { once: true });
            }
        });
    }, 3000);
});
</script>

<!-- ================================================ -->
<!-- KEYBOARD SHORTCUT (Optional) -->
<!-- ================================================ -->

<script>
// Add keyboard shortcut: Ctrl+P to open practice mode
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        window.openPractice();
        console.log('‚å®Ô∏è Practice mode opened via keyboard shortcut');
    }
});

console.log('üí° Tip: Press Ctrl+P to quickly open Practice Mode!');
</script>

<!-- ================================================ -->
<!-- PROGRESS TRACKING ENHANCEMENT -->
<!-- ================================================ -->

<script>
// Track practice session completion and update progress
window.addEventListener('practiceSessionComplete', (event) => {
    const { score, questions, accuracy } = event.detail;
    
    console.log('üìä Practice session completed:', { score, questions, accuracy });
    
    // Update user progress
    if (window.progressAnalytics) {
        window.progressAnalytics.recordPracticeSession({
            score,
            questions,
            accuracy,
            timestamp: new Date().toISOString()
        });
    }
    
    // Show completion notification
    showPracticeCompletionNotification(score, questions, accuracy);
    
    // Optionally award points
    if (window.gamification && accuracy >= 70) {
        const points = Math.round(score * 10);
        window.gamification.awardPoints(points, 'practice_complete');
    }
});

function showPracticeCompletionNotification(score, questions, accuracy) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10001;
        max-width: 350px;
        animation: slideInRight 0.5s ease-out;
    `;
    
    const emoji = accuracy >= 90 ? 'üèÜ' : accuracy >= 70 ? 'üåü' : 'üí™';
    const message = accuracy >= 90 ? 'Excellent work!' : 
                    accuracy >= 70 ? 'Great job!' : 
                    'Keep practicing!';
    
    notification.innerHTML = `
        <h3 style="margin: 0 0 10px 0;">${emoji} Practice Complete!</h3>
        <p style="margin: 0 0 5px 0;">Score: ${score}/${questions}</p>
        <p style="margin: 0 0 10px 0;">Accuracy: ${accuracy}%</p>
        <p style="margin: 0; font-style: italic;">${message}</p>
    `;
    
    document.body.appendChild(notification);
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.style.animation = 'slideInRight 0.5s ease-in reverse';
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}
</script>

<!-- ================================================ -->
<!-- DAILY PRACTICE REMINDER -->
<!-- ================================================ -->

<script>
// Check if user practiced today, show reminder if not
function checkDailyPracticeReminder() {
    const lastPractice = localStorage.getItem('lastPracticeDate');
    const today = new Date().toDateString();
    
    if (lastPractice !== today) {
        // User hasn't practiced today
        setTimeout(() => {
            showDailyPracticeReminder();
        }, 5000); // Show after 5 seconds on page
    }
}

function showDailyPracticeReminder() {
    const reminder = document.createElement('div');
    reminder.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 9999;
        max-width: 300px;
        border-left: 4px solid #667eea;
        animation: bounceIn 0.6s;
    `;
    
    reminder.innerHTML = `
        <div style="display: flex; align-items: start; gap: 15px;">
    
            <div style="flex: 1;">
                <h4 style="margin: 0 0 8px 0; color: #333;">Daily Practice</h4>
                <p style="margin: 0 0 12px 0; font-size: 14px; color: #666;">
                    Keep your streak alive! Take a quick practice session.
                </p>
                <button onclick="window.openPractice(); this.closest('div').closest('div').remove();" 
                        style="background: linear-gradient(135deg, #667eea, #764ba2); 
                               color: white; border: none; padding: 8px 16px; 
                               border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Start Practice
                </button>
                <button onclick="this.closest('div').closest('div').remove();" 
                        style="background: transparent; border: none; 
                               color: #999; padding: 8px 16px; cursor: pointer; 
                               margin-left: 8px;">
                    Later
                </button>
            </div>
        </div>
    `;
    
    // Add bounce animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounceIn {
            0% {
                transform: scale(0.3) translateY(100px);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(reminder);
    
    // Update last practice date when they start
    localStorage.setItem('lastPracticeDate', new Date().toDateString());
}

// Run check on page load
window.addEventListener('load', () => {
    setTimeout(checkDailyPracticeReminder, 3000);
});


async function handleModuleCompletion(moduleName) {
    console.log(`üéâ Module ${moduleName} completed!`);
    
    if (window.tracker) {
        await window.tracker.markComplete(moduleName);
    }
    
    // Update module cards
    updateModuleCardsFromTracker();
}

// Example: When returning from a module page
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const completedModule = urlParams.get('completed');
    
    if (completedModule) {
        handleModuleCompletion(completedModule);
    }
});

// ================================================
// MANUAL REFRESH BUTTON (Optional)
// ================================================

window.refreshProgress = async function() {
    console.log('üîÑ Manually refreshing progress...');
    
    if (window.tracker && userProfile?.userId) {
        // Clear cache
        localStorage.removeItem(`userJourney_${userProfile.userId}`);
        
        // Reinitialize
        await window.tracker.initialize(userProfile.userId);
        
        // Update UI
        updateModuleCardsFromTracker();
        
        alert('‚úÖ Progress refreshed!');
    } else {
        alert('‚ö†Ô∏è Progress tracker not ready');
    }
};

// ================================================
// DEBUG FUNCTIONS
// ================================================

window.debugTracker = function() {
    console.group('üîß Progress Tracker Debug');
    console.log('Tracker initialized:', window.tracker?.initialized);
    console.log('User ID:', window.tracker?.userId);
    console.log('Modules:', window.tracker?.modules);
    console.groupEnd();
};

window.testModuleProgress = async function(moduleName, progress) {
    if (!window.tracker) {
        console.error('Tracker not loaded');
        return;
    }
    
    await window.tracker.updateModuleProgress(moduleName, progress);
    console.log(`‚úÖ Set ${moduleName} to ${progress}%`);
};

console.log('‚úÖ Progress tracker integration code loaded');
console.log('üìù Available functions:');
console.log('   - refreshProgress() - Manual refresh');
console.log('   - debugTracker() - Debug info');
console.log('   - testModuleProgress(name, percent) - Test progress');
</script>

<!-- ================================================ -->
<!-- PRACTICE STATISTICS WIDGET (Optional) -->
<!-- ================================================ -->


<!-- Add this to your main container where you want to show practice stats -->
<div class="practice-stats-widget" id="practiceStatsWidget" style="display: none;">
    <h3>üìä Your Practice Stats</h3>
    <div class="practice-stats-grid">
        <div class="practice-stat-card">
            <div class="practice-stat-value" id="totalPracticeSessions">0</div>
            <div class="practice-stat-label">Sessions</div>
        </div>
        <div class="practice-stat-card">
            <div class="practice-stat-value" id="averageAccuracy">0%</div>
            <div class="practice-stat-label">Accuracy</div>
        </div>
        <div class="practice-stat-card">
            <div class="practice-stat-value" id="practiceStreak">0</div>
            <div class="practice-stat-label">Day Streak</div>
        </div>
    </div>
</div>

<script>
// Load and display practice statistics
function loadPracticeStats() {
    const stats = JSON.parse(localStorage.getItem('practiceStats') || '{"sessions": 0, "totalQuestions": 0, "totalCorrect": 0, "streak": 0}');
    
    document.getElementById('totalPracticeSessions').textContent = stats.sessions;
    
    const accuracy = stats.totalQuestions > 0 
        ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
        : 0;
    document.getElementById('averageAccuracy').textContent = accuracy + '%';
    
    document.getElementById('practiceStreak').textContent = stats.streak;
    
    // Show widget if user has practiced
    if (stats.sessions > 0) {
        document.getElementById('practiceStatsWidget').style.display = 'block';
    }
}

// Update stats after practice session
function updatePracticeStats(score, questions) {
    const stats = JSON.parse(localStorage.getItem('practiceStats') || '{"sessions": 0, "totalQuestions": 0, "totalCorrect": 0, "streak": 0}');
    
    stats.sessions++;
    stats.totalQuestions += questions;
    stats.totalCorrect += score;
    
    // Update streak
    const lastPracticeDate = localStorage.getItem('lastPracticeDate');
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    
    if (lastPracticeDate === yesterday) {
        stats.streak++;
    } else if (lastPracticeDate !== today) {
        stats.streak = 1;
    }
    
    localStorage.setItem('practiceStats', JSON.stringify(stats));
    localStorage.setItem('lastPracticeDate', today);
    
    loadPracticeStats();
}

// Load stats on page load
window.addEventListener('load', loadPracticeStats);
</script>

<!-- ================================================ -->
<!-- CONSOLE CONFIRMATION -->
<!-- ================================================ -->

<script>
console.log('‚úÖ Practice Mode fully integrated');
console.log('üéØ Features:');
console.log('   - 6 practice types with AI generation');
console.log('   - Real-time AI feedback');
console.log('   - Progress tracking');
console.log('   - Daily reminders');
console.log('   - Keyboard shortcut (Ctrl+P)');
console.log('   - Statistics tracking');
</script>
</body>
</html>